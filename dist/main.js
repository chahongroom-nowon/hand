(()=>{"use strict";class e{constructor(e={}){this.frameName=e.frameName||"mainFrame",this.processInterval=e.processInterval||1e3,this.debounceDelay=e.debounceDelay||500,this.observer=null,this.mutationTimeout=null,this.lastProcessTime=0,this.onProcess=e.onProcess||(()=>{})}async waitForElement(e,t,r=5e3){return new Promise(((s,o)=>{const n=Date.now();!function i(){const a=e.querySelector(t);a?s(a):Date.now()-n>=r?o(new Error(`요소(${t})를 ${r}ms 내에 찾지 못했습니다.`)):setTimeout(i,100)}()}))}processMutations(){this.mutationTimeout&&clearTimeout(this.mutationTimeout),this.mutationTimeout=setTimeout((()=>{const e=Date.now();if(e-this.lastProcessTime>=this.processInterval)try{const t=document.querySelector(`frame[name="${this.frameName}"], frame#${this.frameName}`);t&&(t.contentDocument||t.contentWindow.document)&&(this.onProcess(t.contentDocument||t.contentWindow.document),this.lastProcessTime=e)}catch(e){console.error("❌ process() 실행 중 오류:",e)}}),this.debounceDelay)}initializeObserver(){const e=document.querySelector(`frame[name="${this.frameName}"], frame#${this.frameName}`);e&&e.contentDocument&&e.contentDocument.body?(this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((()=>this.processMutations())),this.observer.observe(e.contentDocument.body,{childList:!0,subtree:!0,characterData:!0,attributes:!0}),this.onProcess(e.contentDocument)):console.warn("⚠️ iframe 내부 문서 또는 body에 접근할 수 없습니다.")}start(){const e=document.querySelector(`frame[name="${this.frameName}"], frame#${this.frameName}`);e?(e.addEventListener("load",(()=>this.initializeObserver())),"complete"===e.contentDocument?.readyState&&this.initializeObserver()):console.error(`❌ ${this.frameName} 요소를 찾을 수 없습니다.`),"complete"===document.readyState?this.initializeObserver():window.addEventListener("load",(()=>{const e=document.querySelector(`frame[name="${this.frameName}"], frame#${this.frameName}`);"complete"===e?.contentDocument?.readyState?this.initializeObserver():setTimeout((()=>this.initializeObserver()),500)}))}stop(){this.observer&&(this.observer.disconnect(),this.observer=null),this.mutationTimeout&&(clearTimeout(this.mutationTimeout),this.mutationTimeout=null)}}const t=new class{constructor(){this.observer=new e({frameName:"mainFrame",onProcess:e=>this.processFrame(e)})}processFrame(e){e.querySelectorAll('a[title="예약금지삭제"], a[onclick^="jsReserveStop"]').forEach((t=>{if("true"===t.dataset.confirmInjected)return;t.dataset.confirmInjected="true";const r=t.getAttribute("onclick");t.onclick=s=>this.handleButtonClick(s,t,r,e)}))}handleButtonClick(e,t,r,s){if(e.preventDefault(),confirm("! 예약금지를 취소하셨습니다 !\n! 실수로 누른 경우 다시 예약을 꼭 막아주세요 !")){if(r){const e=r.match(/jsStopTimeDel\\((.*)\\)/);if(e){const r=e[1].split(",").map((e=>e.trim().replace(/^'(.*)'$/,"$1"))),o=s.defaultView;"function"==typeof o.jsStopTimeDel?o.jsStopTimeDel(...r.slice(0,6),t):alert("jsStopTimeDel 함수를 찾을 수 없습니다.")}}}else console.log("예약금지 취소 - 사용자 취소")}start(){this.observer.start()}stop(){this.observer.stop()}},r=new class{constructor(){this.waitingNames=["재희W","광숙W","지후W","윤진W","정현W","소연W","희선W","희진W","소이W","재열W","예나W"],this.observer=new e({frameName:"mainFrame",onProcess:e=>this.processFrame(e)})}getWaitingButtonsHTML(){return`\n            <ul style="margin:0; padding:0;">\n            ${this.waitingNames.reduce(((e,t,r)=>(r%3==0&&(e+='<li style="display:block; margin:4px 0;">'),e+=`\n                    <span class="nBtn line jwaiting"\n                        style="cursor:pointer; display:inline-block; padding:2px 8px; border:1px solid #ccc; border-radius:3px; margin-right:4px;">\n                        ${t}\n                    </span>\n                `,r%3!=2&&r!==this.waitingNames.length-1||(e+="</li>"),e)),"")}\n            </ul>\n        `}async processFrame(e){if(!e)return void console.warn("❌ iframe 내부 문서 접근 불가");const t=e.querySelector("div#cashReceiptLayer");if(!t)return void console.log("❌ cashReceiptLayer를 찾을 수 없습니다.");const r=t.parentElement;if(!r)return void console.log("❌ cashReceiptLayer의 부모 요소를 찾을 수 없습니다.");const s=Array.from(r.children).find((e=>"TABLE"===e.tagName&&e!==t));s?"true"!==s.dataset.buttonsAdded&&(s.insertAdjacentHTML("beforeend",this.getWaitingButtonsHTML()),s.dataset.buttonsAdded="true",e.querySelectorAll(".nBtn.line.jwaiting").forEach((t=>{"true"!==t.dataset.waitingProcessed&&(t.dataset.waitingProcessed="true",t.addEventListener("click",(r=>this.handleButtonClick(r,t,e))))}))):console.log("❌ cashReceiptLayer의 형제 테이블을 찾을 수 없습니다.")}async handleButtonClick(e,t,r){e.preventDefault();const s=t.innerText.trim();try{(await this.observer.waitForElement(r,'td.tal.tind[onclick="linkSelectCateg_Change(this);"]')).click(),(await this.observer.waitForElement(r,'td[onclick*="categChange"][onclick*="시술전"]')).click(),(await this.observer.waitForElement(r,'td.m2[id*="시술중"]')).click();const e=r.getElementById("strMemo");e?e.value=e.value+`\n\n1.\n2.${s}\n3.\n4.`:console.error("❌ textarea#strMemo를 찾을 수 없습니다.")}catch(e){console.error("❌ 작업 처리 중 오류:",e)}}start(){this.observer.start()}stop(){this.observer.stop()}},s=new class{constructor(){this.priority=["펌","컬러","클리닉","커트","컨설팅"],this.normalizeMap={컷:"커트"},this.observer=new e({frameName:"mainFrame",onProcess:e=>this.processFrame(e)}),this.pageObserver=null}processMenu(e=document){const t=e.querySelectorAll("#today > table")[1];t?t.querySelectorAll("tbody > tr").forEach((e=>{const t=(e.getAttribute("ismemo")||"").match(/예약시술메뉴\s*:\s*(.*?)\s*예약금/);if(t){let r=t[1];for(const[e,t]of Object.entries(this.normalizeMap))r.includes(e)&&(r=r.replace(new RegExp(e,"g"),t));let s=null;for(const e of this.priority)if(r.includes(e)){s=e;break}if(s){const t=e.querySelector("td:nth-of-type(4)");t&&""===t.textContent.trim()&&(t.textContent=s,console.log(`✅ 메뉴 설정: ${s} (원본: ${r})`))}}})):console.error("❌ 두 번째 테이블을 찾을 수 없습니다.")}processFrame(e){try{e.querySelector("#today")&&this.processMenu(e)}catch(e){console.error("iframe 접근 오류:",e)}}isMainFrame(){try{return"mainFrame"===window.self.name}catch(e){return!1}}initialize(){if(this.isMainFrame()){const e=setInterval((()=>{if(document.querySelector("#today")){clearInterval(e),this.processMenu();const t=document.querySelector("#today");t&&new MutationObserver((()=>{this.processMenu()})).observe(t,{childList:!0,subtree:!0})}}),1e3);setTimeout((()=>{clearInterval(e)}),3e4)}}start(){this.observer.start(),this.initialize(),document.querySelectorAll("iframe").forEach((e=>this.processFrame(e.contentDocument||e.contentWindow.document))),this.pageObserver=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{"IFRAME"===e.nodeName&&this.processFrame(e.contentDocument||e.contentWindow.document)}))}))})),this.pageObserver.observe(document.body,{childList:!0,subtree:!0})}stop(){this.observer.stop(),this.pageObserver&&(this.pageObserver.disconnect(),this.pageObserver=null)}},o=new class{constructor(){this.observer=new e({frameName:"mainFrame",onProcess:e=>this.processFrame(e)})}processFrame(e){if(!e)return void console.warn("❌ iframe 내부 문서 접근 불가");const t=e.querySelectorAll("div[event_id]");t.length?t.forEach((t=>{const r=t.getAttribute("event_id"),s=t.querySelector("div.dhx_body"),o=s?.querySelector("a.regCust");if(!o)return;if("true"===o.dataset.visitInfoProcessed)return;o.dataset.visitInfoProcessed="true";const n=s.querySelector("b.rsvAlarm0");if(!n)return void console.warn(`⚠️ b.rsvAlarm0 요소 없음 (event_id: ${r})`);const i=n.textContent.trim().toLowerCase(),a=s.querySelector('b[data-tag="visitInfo-consulting"]'),c=s.querySelector('b[data-tag="visitInfo-ncu"]');if(["cs","ㅊㄴ"].includes(i))return a&&a.remove(),void(c&&c.remove());const l=e.querySelector(`#strHiddenReplaceCustname_${r}`);if(!l)return void console.warn(`⚠️ strHiddenReplaceCustname_${r} 입력 필드 없음`);const d=l.value.match(/최근방문일\s*:\s*(\d{4}-\d{2}-\d{2})/);let m=!1,u=!1;if(d){const e=d[1];new Date(e)<new Date("2025-04-01")&&(m=!0)}else m=!0,u=!0;if(s&&!s.dataset.positionRelativeSet&&(s.style.position="relative",s.dataset.positionRelativeSet="true"),m){if(!a){const e=document.createElement("b");e.textContent="컨설팅",e.setAttribute("data-tag","visitInfo-consulting"),Object.assign(e.style,{fontSize:"9px",fontWeight:"100",position:"absolute",right:"0",top:"0",color:"#555",background:"#f0f0f0",padding:"1px 4px",borderRadius:"3px",pointerEvents:"none",zIndex:"10"}),o.appendChild(e)}}else a&&a.remove();if(u){if(!c){const e=document.createElement("b");e.textContent="N CU",e.setAttribute("data-tag","visitInfo-ncu"),Object.assign(e.style,{fontSize:"9px",fontWeight:"100",position:"absolute",right:"0",top:"15px",color:"#555",background:"#f0f0f0",padding:"1px 4px",borderRadius:"3px",pointerEvents:"none",zIndex:"10"}),o.appendChild(e)}}else c&&c.remove()})):console.log("ℹ️ event_id를 가진 div 없음")}start(){this.observer.start()}stop(){this.observer.stop()}},n=new class{constructor(){this.observer=new e({frameName:"mainFrame",onProcess:e=>this.processFrame(e)})}processFrame(e){e?(e.querySelectorAll("a").forEach((t=>{t.textContent.includes("설문")&&!t.dataset.modified&&(t.innerHTML='<span class="tcGreen" style="font-size:11px;">컨설팅</span>지오',t.setAttribute("tip-data","메모에 컨설팅지오 기입"),t.dataset.modified="true",t.addEventListener("click",this.handleConsultingGeoClick(e)))})),this.hideLinkByText(e,"손님영업","손님영업"),this.hideLinkByText(e,"방문기록지","방문기록지")):console.error("❌ iframe 문서 객체 접근 실패")}hideLinkByText(e,t,r){e.querySelectorAll("a").forEach((e=>{e.textContent.includes(t)&&!e.dataset.hidden&&(e.style.setProperty("display","none","important"),e.dataset.hidden="true")}))}handleConsultingGeoClick(e){return t=>{t.preventDefault();const r=e.querySelector("#pkCustomer_Memo");if(r){r.value.startsWith("컨설팅지오\n")||(r.value="컨설팅지오\n"+r.value);const t=e.querySelector('a[onclick="jsCustomerMemoUpdateHide();"]');t&&t.click()}}}start(){this.observer.start()}stop(){this.observer.stop()}},i=new class{constructor(){this.keywordPriority=["R1","P","CL","TM","D","C","컨설팅"],this.keywordMap={컷:"C",펌:"P",컬러:"CL",클리닉:"TM",드라이:"D",R1:"R1",부분펌:"P",컨설팅:"컨설팅"},this.observer=new e({frameName:"mainFrame",onProcess:e=>this.processFrame(e)})}startTextareaPolling(e){e._textareaPollingId||(e._processedElements||(e._processedElements=new Set),e._textareaPollingId=setInterval((()=>{e.querySelectorAll('textarea[id^="strMemo_"]').forEach((t=>{const r=t.id.match(/strMemo_(\d+)/);if(!r)return;const s=r[1],o=e._processedElements;o.has(s)&&(t.dataset.prevValue||"")!==t.value&&o.delete(s),t.dataset.prevValue=t.value}))}),1e3))}processFrame(e){if(!e)return void console.warn("⚠️ iframe 또는 내부 문서가 없습니다.");this.startTextareaPolling(e);const t=e._processedElements;try{e.querySelectorAll('textarea[id^="strMemo_"]').forEach((r=>{const s=r.id.match(/strMemo_(\d+)/);if(!s)return;const o=s[1];if(t.has(o))return;const n=r.value,i=n.match(/예약시술메뉴\s*:\s*(.*?)\s*2024년/);if(!i)return;const a=i[1],c=Object.entries(this.keywordMap).filter((([e])=>a.includes(e))).map((([,e])=>e));if(0===c.length)return;const l=this.keywordPriority.find((e=>c.includes(e)));if(!l)return;const d=e.querySelector(`div[event_id="${o}"] div.dhx_body a.regLink span.menuType span`);if(d&&d.textContent!==l&&(d.textContent=l),n.includes("요청사항:")){const t=e.querySelector(`div[event_id="${o}"] div.dhx_event_move.dhx_title`);t&&(t.textContent="요청사항 확인",t.style.background="#546679",t.style.color="#ffffff",t.style.fontWeight="bold")}t.add(o),r.dataset.prevValue=r.value}))}catch(e){console.error("❌ strMemo_ 처리 중 오류:",e)}try{e.querySelectorAll("div.rDetail").forEach((e=>{const t=e.querySelector("div > dl > dd:last-child > div.nrRMemo");if(!t)return;const r=e.parentElement.querySelector("div.rInner");r&&t.textContent.includes("요청사항:")&&(r.style.boxShadow="inset 0 0 0 2px red")}))}catch(e){console.error("❌ rDetail 처리 중 오류:",e)}}start(){this.observer.start()}stop(){this.observer.stop()}};t.start(),r.start(),s.start(),o.start(),n.start(),i.start()})();